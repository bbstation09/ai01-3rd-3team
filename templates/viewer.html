<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Î°úÍ∑∏ Î∑∞Ïñ¥ | Ìã∞Ïºì ÏòàÎß§</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Malgun Gothic', 'Apple SD Gothic Neo', sans-serif;
        }

        body {
            background: #f5f5f7;
            min-height: 100vh;
        }

        .header {
            background: #fff;
            padding: 16px 40px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        .logo {
            font-size: 24px;
            font-weight: bold;
            color: #6b4fbb;
            text-decoration: none;
        }

        .logo span {
            color: #ff6b6b;
        }

        .nav-links {
            display: flex;
            gap: 16px;
        }

        .nav-links a {
            padding: 8px 16px;
            background: #f5f5f5;
            border-radius: 6px;
            color: #666;
            text-decoration: none;
            font-size: 14px;
        }

        .nav-links a:hover {
            background: #eee;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 30px;
        }

        .page-title {
            font-size: 24px;
            margin-bottom: 24px;
            color: #333;
        }

        .content-grid {
            display: grid;
            grid-template-columns: 400px 1fr;
            gap: 24px;
        }

        .card {
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            overflow: hidden;
        }

        .card-header {
            padding: 16px 20px;
            background: #f8f8f8;
            border-bottom: 1px solid #eee;
            font-weight: 600;
            font-size: 15px;
        }

        .log-list {
            max-height: 600px;
            overflow-y: auto;
        }

        .log-item {
            padding: 14px 20px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: background 0.2s;
        }

        .log-item:hover {
            background: #f8f5ff;
        }

        .log-item.active {
            background: #f0ebff;
            border-left: 4px solid #6b4fbb;
        }

        .log-item.bot {
            background: #fff5f5;
        }

        .log-item.bot.active {
            background: #ffe0e0;
            border-left-color: #dc3545;
        }

        .log-filename {
            font-size: 12px;
            color: #888;
            margin-bottom: 4px;
            font-family: monospace;
        }

        .log-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .log-badge {
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
        }

        .log-badge.human {
            background: #e3f2fd;
            color: #1976d2;
        }

        .log-badge.bot {
            background: #ffebee;
            color: #d32f2f;
        }

        .log-duration {
            font-size: 12px;
            color: #666;
        }

        /* ÏÉÅÏÑ∏ Î∑∞ */
        .detail-section {
            padding: 20px;
        }

        .detail-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 16px;
            color: #333;
        }

        .detail-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 24px;
        }

        .detail-item {
            background: #f8f8f8;
            padding: 12px;
            border-radius: 8px;
        }

        .detail-label {
            font-size: 12px;
            color: #888;
            margin-bottom: 4px;
        }

        .detail-value {
            font-size: 14px;
            font-weight: 600;
            color: #333;
        }

        /* Í∂§Ï†Å ÏãúÍ∞ÅÌôî */
        .trajectory-container {
            position: relative;
            margin-bottom: 20px;
        }

        .trajectory-canvas {
            width: 100%;
            height: 500px;
            background: #1a1a2e;
            border-radius: 12px;
        }

        .trajectory-controls {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
            align-items: center;
        }

        .trajectory-controls button {
            padding: 8px 14px;
            border: none;
            border-radius: 6px;
            background: #6b4fbb;
            color: #fff;
            cursor: pointer;
            font-size: 13px;
        }

        .trajectory-controls button:hover {
            background: #5a3ea8;
        }

        .trajectory-controls span {
            font-size: 13px;
            color: #666;
        }

        .trajectory-info {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: #fff;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-family: monospace;
        }

        .click-tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.9);
            color: #fff;
            padding: 10px 14px;
            border-radius: 8px;
            font-size: 12px;
            pointer-events: none;
            z-index: 100;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            display: none;
            max-width: 220px;
            line-height: 1.5;
        }

        .click-tooltip .stage {
            color: #ff6b6b;
            font-weight: 700;
            font-size: 13px;
        }

        .click-tooltip .coords {
            color: #aaa;
            font-family: monospace;
        }

        .click-tooltip .target {
            color: #667eea;
        }

        /* ÌÜµÍ≥Ñ */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
            padding: 16px;
            border-radius: 12px;
            text-align: center;
        }

        .stat-value {
            font-size: 28px;
            font-weight: 800;
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 12px;
            opacity: 0.8;
        }

        .stat-card.warning {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a5a 100%);
        }

        .stat-card.success {
            background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
        }

        /* JSON Î∑∞ */
        .json-view {
            background: #1a1a2e;
            color: #a5d6a7;
            padding: 16px;
            border-radius: 12px;
            font-family: 'Consolas', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow: auto;
            white-space: pre-wrap;
            word-break: break-all;
        }

        .empty-state {
            text-align: center;
            padding: 60px;
            color: #888;
        }

        .empty-state .icon {
            font-size: 48px;
            margin-bottom: 16px;
        }
    </style>
</head>

<body>
    <header class="header">
        <a href="/performances" class="logo">TICKET<span>PARK</span></a>
        <div class="nav-links">
            <a href="/performances">Í≥µÏó∞ Î™©Î°ù</a>
            <a href="/logout">Î°úÍ∑∏ÏïÑÏõÉ</a>
        </div>
    </header>

    <div class="container">
        <h1 class="page-title">üìä Î°úÍ∑∏ Î∑∞Ïñ¥</h1>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="totalLogs">{{ log_files|length }}</div>
                <div class="stat-label">Ï†ÑÏ≤¥ Î°úÍ∑∏</div>
            </div>
            <div class="stat-card success">
                <div class="stat-value" id="humanLogs">{{ log_files|selectattr('is_bot', 'false')|list|length }}</div>
                <div class="stat-label">Ï†ïÏÉÅ ÏÇ¨Ïö©Ïûê</div>
            </div>
            <div class="stat-card warning">
                <div class="stat-value" id="botLogs">{{ log_files|selectattr('is_bot')|list|length }}</div>
                <div class="stat-label">Î¥á ÌÉêÏßÄ</div>
            </div>
        </div>

        <div class="content-grid">
            <div class="card">
                <div class="card-header">ÏÑ∏ÏÖò Î°úÍ∑∏ Î™©Î°ù</div>
                <div class="log-list">
                    {% if log_files %}
                    {% for log in log_files %}
                    <div class="log-item {% if log.is_bot %}bot{% endif %}" onclick="loadLog('{{ log.filename }}')"
                        id="log-{{ loop.index }}">
                        <div class="log-filename">{{ log.created_at[:19] if log.created_at else '-' }} | {{
                            log.session_id }} | {{ log.display_stage }}</div>
                        <div class="log-info">
                            <span class="log-badge {% if log.is_bot %}bot{% else %}human{% endif %}">
                                {% if log.is_bot %}ü§ñ BOT{% else %}üë§ {{ log.user_email or 'Human' }}{% endif %}
                            </span>
                            <span class="log-duration">{{ (log.duration / 1000)|round(1) }}Ï¥à</span>
                        </div>
                    </div>
                    {% endfor %}
                    {% else %}
                    <div class="empty-state">
                        <div class="icon">üì≠</div>
                        <p>Î°úÍ∑∏Í∞Ä ÏóÜÏäµÎãàÎã§</p>
                    </div>
                    {% endif %}
                </div>
            </div>

            <div class="card">
                <div class="card-header">ÏÉÅÏÑ∏ Ï†ïÎ≥¥</div>
                <div id="detailContent">
                    <div class="empty-state">
                        <div class="icon">üëà</div>
                        <p>Î°úÍ∑∏Î•º ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentLog = null;

        async function loadLog(filename) {
            // ÌôúÏÑ± ÏÉÅÌÉú Î≥ÄÍ≤Ω
            document.querySelectorAll('.log-item').forEach(el => el.classList.remove('active'));
            event.currentTarget.classList.add('active');

            const response = await fetch(`/api/logs/${filename}`);
            const data = await response.json();
            currentLog = data;

            renderDetail(data);
        }

        function renderDetail(data) {
            const container = document.getElementById('detailContent');

            const isBot = data.is_bot || false;
            const botScore = data.bot_score || 0;

            // Ï≤¥Î•ò ÏãúÍ∞Ñ Í≥ÑÏÇ∞
            let durationMs = data.total_duration_ms || data.wait_duration_ms || 0;
            if (durationMs === 0) {
                if (data.page_entry_time && data.page_exit_time) {
                    durationMs = new Date(data.page_exit_time) - new Date(data.page_entry_time);
                } else if (data.queue_start_time && data.queue_end_time) {
                    durationMs = new Date(data.queue_end_time) - new Date(data.queue_start_time);
                } else if (data.booking_start_time && data.booking_end_time) {
                    durationMs = new Date(data.booking_end_time) - new Date(data.booking_start_time);
                }
            }

            // ÎßàÏö∞Ïä§ Í∂§Ï†Å ÌÜµÌï© - Ïã§Ï†ú ÏòàÎß§ ÌùêÎ¶Ñ ÏàúÏÑú: captcha ‚Üí section ‚Üí seats ‚Üí discount ‚Üí booker ‚Üí payment
            let allTrajectory = [];
            if (data.mouse_trajectory) {
                allTrajectory = allTrajectory.concat(data.mouse_trajectory.map(p => ({ ...p, stage: 'Í∏∞ÌÉÄ' })));
            }
            if (data.captcha?.mouse_trajectory) {
                allTrajectory = allTrajectory.concat(data.captcha.mouse_trajectory.map(p => ({ ...p, stage: 'üîí Î≥¥ÏïàÎ¨∏Ïûê' })));
            }
            if (data.section_selection?.mouse_trajectory) {
                allTrajectory = allTrajectory.concat(data.section_selection.mouse_trajectory.map(p => ({ ...p, stage: 'üìç Íµ¨Ïó≠ÏÑ†ÌÉù' })));
            }
            if (data.mouse_trajectory_seats) {
                allTrajectory = allTrajectory.concat(data.mouse_trajectory_seats.map(p => ({ ...p, stage: 'üé´ Ï¢åÏÑùÏÑ†ÌÉù' })));
            }
            if (data.mouse_trajectory_discount) {
                allTrajectory = allTrajectory.concat(data.mouse_trajectory_discount.map(p => ({ ...p, stage: 'üí≥ Ìï†Ïù∏Í∂åÏ¢Ö' })));
            }
            if (data.mouse_trajectory_booker) {
                allTrajectory = allTrajectory.concat(data.mouse_trajectory_booker.map(p => ({ ...p, stage: 'üöö Î∞∞ÏÜ°ÏÑ†ÌÉù' })));
            }
            if (data.mouse_trajectory_payment) {
                allTrajectory = allTrajectory.concat(data.mouse_trajectory_payment.map(p => ({ ...p, stage: 'üí∞ Í≤∞Ï†úÏàòÎã®' })));
            }

            // ÌÅ¥Î¶≠ Îç∞Ïù¥ÌÑ∞ ÌÜµÌï© (stage Ï†ïÎ≥¥ Ìè¨Ìï®)
            let allClicks = [];

            // Í∏∞Î≥∏ clicks
            if (data.clicks) {
                allClicks = allClicks.concat(data.clicks.map(c => ({ ...c, stage: 'Í∏∞ÌÉÄ' })));
            }
            // Ï¢åÏÑù ÏÑ†ÌÉù
            if (data.seat_selection?.clicks) {
                allClicks = allClicks.concat(data.seat_selection.clicks.map(c => ({ ...c, stage: 'üé´ Ï¢åÏÑùÏÑ†ÌÉù' })));
            }
            // Ï∫îÏ∞®
            if (data.captcha?.clicks) {
                allClicks = allClicks.concat(data.captcha.clicks.map(c => ({ ...c, stage: 'üîí Î≥¥ÏïàÎ¨∏Ïûê' })));
            }
            // Íµ¨Ïó≠ ÏÑ†ÌÉù
            if (data.section_selection?.clicks) {
                const validClicks = data.section_selection.clicks
                    .filter(c => c.x !== undefined && c.y !== undefined)
                    .map(c => ({ ...c, stage: 'üìç Íµ¨Ïó≠ÏÑ†ÌÉù', target: c.section }));
                allClicks = allClicks.concat(validClicks);
            }
            // Ìï†Ïù∏Í∂åÏ¢Ö
            if (data.clicks_discount) {
                allClicks = allClicks.concat(data.clicks_discount.map(c => ({ ...c, stage: 'üí≥ Ìï†Ïù∏Í∂åÏ¢Ö' })));
            }
            // ÏòàÎß§ÏûêÏ†ïÎ≥¥
            if (data.clicks_booker) {
                allClicks = allClicks.concat(data.clicks_booker.map(c => ({ ...c, stage: 'üöö Î∞∞ÏÜ°ÏÑ†ÌÉù' })));
            }
            // Í≤∞Ï†ú
            if (data.clicks_payment) {
                allClicks = allClicks.concat(data.clicks_payment.map(c => ({ ...c, stage: 'üí∞ Í≤∞Ï†úÏàòÎã®' })));
            }

            // Ìò∏Î≤Ñ ÌöüÏàò Í≥ÑÏÇ∞ (actionsÏóêÏÑú hoverÍ¥ÄÎ†® Ïù¥Î≤§Ìä∏ ÏßëÍ≥Ñ)
            let hoverCount = (data.hovers || []).length;
            if (data.seat_selection?.hovers) hoverCount += data.seat_selection.hovers.length;
            if (hoverCount === 0 && data.actions) {
                hoverCount = data.actions.filter(a => a.action && a.action.includes('hover')).length;
            }

            // ÌÅ¥Î¶≠ ÌöüÏàò Í≥ÑÏÇ∞
            let clickCount = allClicks.length;
            if (clickCount === 0 && data.actions) {
                clickCount = data.actions.filter(a => a.action && (a.action.includes('click') || a.action.includes('select'))).length;
            }
            if (clickCount === 0 && data.card_clicks) {
                clickCount = data.card_clicks.length +
                    (data.date_selections || []).length +
                    (data.time_selections || []).length;
            }
            if (data.section_selection?.clicks) clickCount += data.section_selection.clicks.length;

            // Îã®Í≥Ñ ÌëúÏãú
            const stageLabels = { 'perf': 'üé≠ Í≥µÏó∞Ï∞Ω', 'que': '‚è≥ ÎåÄÍ∏∞Ïó¥', 'book': 'üé´ ÏòàÎß§Ï∞Ω' };
            const stageLabel = stageLabels[data.stage] || data.stage || '-';

            container.innerHTML = `
                <div class="detail-section">
                    <h3 class="detail-title">ÏÑ∏ÏÖò Ï†ïÎ≥¥</h3>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <div class="detail-label">ÏÑ∏ÏÖò ID</div>
                            <div class="detail-value">${data.session_id || '-'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">ÏÇ¨Ïö©Ïûê ID</div>
                            <div class="detail-value">${data.user_email || data.user_id || '-'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">IP Ï£ºÏÜå</div>
                            <div class="detail-value">${data.user_ip || '-'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Îã®Í≥Ñ</div>
                            <div class="detail-value">${stageLabel}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Ï≤¥Î•ò ÏãúÍ∞Ñ</div>
                            <div class="detail-value">${(durationMs / 1000).toFixed(1)}Ï¥à</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Î¥á Ïä§ÏΩîÏñ¥</div>
                            <div class="detail-value" style="color: ${botScore > 0.7 ? '#dc3545' : botScore > 0.4 ? '#ffc107' : '#28a745'}">
                                ${(botScore * 100).toFixed(0)}%
                            </div>
                        </div>
                    </div>
                    
                    ${isBot ? `
                        <div style="background: #fff5f5; border: 1px solid #ffcdd2; padding: 12px; border-radius: 8px; margin-bottom: 20px;">
                            <strong style="color: #d32f2f;">ü§ñ Î¥á ÌÉêÏßÄ</strong>
                            <p style="margin-top: 4px; font-size: 13px; color: #666;">
                                Ïú†Ìòï: ${data.bot_type || '-'} (${data.bot_description || '-'})
                            </p>
                        </div>
                    ` : ''}
                    
                    <h3 class="detail-title">ÎßàÏö∞Ïä§ Í∂§Ï†Å</h3>
                    <div class="trajectory-controls">
                        <button onclick="zoomTrajectory(1.2)">üîç+ ÌôïÎåÄ</button>
                        <button onclick="zoomTrajectory(0.8)">üîç- Ï∂ïÏÜå</button>
                        <button onclick="resetZoom()">‚Ü∫ Î¶¨ÏÖã</button>
                        <span id="zoomLevel">100%</span>
                    </div>
                    <div class="trajectory-container">
                        <canvas class="trajectory-canvas" id="trajectoryCanvas"></canvas>
                        <div class="trajectory-info" id="trajectoryInfo">Ìï¥ÏÉÅÎèÑ: - | Ìè¨Ïù∏Ìä∏: -</div>
                        <div class="click-tooltip" id="clickTooltip"></div>
                    </div>
                    
                    <h3 class="detail-title">ÌñâÎèô ÌÜµÍ≥Ñ</h3>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <div class="detail-label">ÎßàÏö∞Ïä§ Í∂§Ï†Å Ìè¨Ïù∏Ìä∏</div>
                            <div class="detail-value">${allTrajectory.length}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">ÌÅ¥Î¶≠/ÏÑ†ÌÉù ÌöüÏàò</div>
                            <div class="detail-value">${clickCount}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Ìò∏Î≤Ñ ÌöüÏàò</div>
                            <div class="detail-value">${hoverCount}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">ÏÑ†ÌÉù Ï¢åÏÑù</div>
                            <div class="detail-value">${(data.selected_seats || data.seat_selection?.seats || data.seats?.selected || []).join(', ') || '-'}</div>
                        </div>
                    </div>
                    
                    <h3 class="detail-title">ÏõêÎ≥∏ Îç∞Ïù¥ÌÑ∞</h3>
                    <div class="json-view">${JSON.stringify(data, null, 2)}</div>
                </div>
            `;

            // Í∂§Ï†Å Í∑∏Î¶¨Í∏∞ - ÌÜµÌï©Îêú Í∂§Ï†ÅÍ≥º ÌÅ¥Î¶≠ ÏÇ¨Ïö©
            drawTrajectory(allTrajectory, allClicks);
        }

        let currentZoom = 1;
        let currentTrajectory = [];
        let currentClicks = [];

        function zoomTrajectory(factor) {
            currentZoom *= factor;
            currentZoom = Math.max(0.5, Math.min(3, currentZoom));
            document.getElementById('zoomLevel').textContent = Math.round(currentZoom * 100) + '%';
            drawTrajectory(currentTrajectory, currentClicks);
        }

        function resetZoom() {
            currentZoom = 1;
            document.getElementById('zoomLevel').textContent = '100%';
            drawTrajectory(currentTrajectory, currentClicks);
        }

        function drawTrajectory(trajectory, clicks) {
            currentTrajectory = trajectory;
            currentClicks = clicks;

            const canvas = document.getElementById('trajectoryCanvas');
            if (!canvas) return;

            const ctx = canvas.getContext('2d');
            const rect = canvas.getBoundingClientRect();
            canvas.width = rect.width * 2; // Í≥†Ìï¥ÏÉÅÎèÑ
            canvas.height = rect.height * 2;
            ctx.scale(2, 2);

            const displayWidth = rect.width;
            const displayHeight = rect.height;

            // Î∞∞Í≤Ω
            ctx.fillStyle = '#1a1a2e';
            ctx.fillRect(0, 0, displayWidth, displayHeight);

            if (trajectory.length === 0) {
                ctx.fillStyle = '#666';
                ctx.font = '14px sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText('Í∂§Ï†Å Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå', displayWidth / 2, displayHeight / 2);
                return;
            }

            // ÏõêÎ≥∏ Ìï¥ÏÉÅÎèÑ Í≥ÑÏÇ∞ (Îç∞Ïù¥ÌÑ∞ Í∏∞Î∞ò)
            const allPoints = [...trajectory, ...clicks.filter(c => c.x !== undefined)];
            const maxX = Math.max(...allPoints.map(p => p.x || 0), 1920);
            const maxY = Math.max(...allPoints.map(p => p.y || 0), 1080);

            // ÌôîÎ©¥ ÎπÑÏú® Ïú†ÏßÄ (16:9 ÎòêÎäî Îç∞Ïù¥ÌÑ∞ Í∏∞Î∞ò)
            const aspectRatio = maxX / maxY;
            const padding = 30;

            let drawWidth, drawHeight;
            if ((displayWidth - padding * 2) / (displayHeight - padding * 2) > aspectRatio) {
                drawHeight = (displayHeight - padding * 2) * currentZoom;
                drawWidth = drawHeight * aspectRatio;
            } else {
                drawWidth = (displayWidth - padding * 2) * currentZoom;
                drawHeight = drawWidth / aspectRatio;
            }

            const offsetX = (displayWidth - drawWidth) / 2;
            const offsetY = (displayHeight - drawHeight) / 2;
            const scaleX = drawWidth / maxX;
            const scaleY = drawHeight / maxY;

            // Í≤©ÏûêÏÑ† Í∑∏Î¶¨Í∏∞
            ctx.strokeStyle = 'rgba(255,255,255,0.1)';
            ctx.lineWidth = 0.5;
            const gridStep = 200;
            for (let gx = 0; gx <= maxX; gx += gridStep) {
                const x = gx * scaleX + offsetX;
                ctx.beginPath();
                ctx.moveTo(x, offsetY);
                ctx.lineTo(x, offsetY + drawHeight);
                ctx.stroke();
            }
            for (let gy = 0; gy <= maxY; gy += gridStep) {
                const y = gy * scaleY + offsetY;
                ctx.beginPath();
                ctx.moveTo(offsetX, y);
                ctx.lineTo(offsetX + drawWidth, y);
                ctx.stroke();
            }

            // ÌÖåÎëêÎ¶¨ (ÌôîÎ©¥ ÏòÅÏó≠ ÌëúÏãú)
            ctx.strokeStyle = 'rgba(255,255,255,0.3)';
            ctx.lineWidth = 1;
            ctx.strokeRect(offsetX, offsetY, drawWidth, drawHeight);

            // Í∂§Ï†Å Í∑∏Î¶¨Í∏∞
            ctx.strokeStyle = '#667eea';
            ctx.lineWidth = 2;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            ctx.beginPath();

            trajectory.forEach((point, i) => {
                const x = point.x * scaleX + offsetX;
                const y = point.y * scaleY + offsetY;

                if (i === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            });
            ctx.stroke();

            // ÌÅ¥Î¶≠ Ìè¨Ïù∏Ìä∏ (Îπ®Í∞Ñ Ï†ê)
            clicks.forEach(click => {
                if (click.x === undefined || click.y === undefined) return;
                const x = click.x * scaleX + offsetX;
                const y = click.y * scaleY + offsetY;

                ctx.fillStyle = '#ff6b6b';
                ctx.beginPath();
                ctx.arc(x, y, 8, 0, Math.PI * 2);
                ctx.fill();

                // ÌÅ¥Î¶≠ ÌÖåÎëêÎ¶¨
                ctx.strokeStyle = '#fff';
                ctx.lineWidth = 2;
                ctx.stroke();
            });

            // ÏãúÏûëÏ†ê (ÎÖπÏÉâ)
            if (trajectory.length > 0) {
                const startX = trajectory[0].x * scaleX + offsetX;
                const startY = trajectory[0].y * scaleY + offsetY;
                ctx.fillStyle = '#2ecc71';
                ctx.beginPath();
                ctx.arc(startX, startY, 10, 0, Math.PI * 2);
                ctx.fill();
                ctx.strokeStyle = '#fff';
                ctx.lineWidth = 2;
                ctx.stroke();
            }

            // ÎÅùÏ†ê (Ï£ºÌô©ÏÉâ)
            if (trajectory.length > 1) {
                const endX = trajectory[trajectory.length - 1].x * scaleX + offsetX;
                const endY = trajectory[trajectory.length - 1].y * scaleY + offsetY;
                ctx.fillStyle = '#f39c12';
                ctx.beginPath();
                ctx.arc(endX, endY, 8, 0, Math.PI * 2);
                ctx.fill();
                ctx.strokeStyle = '#fff';
                ctx.lineWidth = 2;
                ctx.stroke();
            }

            // Ï†ïÎ≥¥ ÌëúÏãú
            const info = document.getElementById('trajectoryInfo');
            if (info) {
                info.textContent = `Ìï¥ÏÉÅÎèÑ: ${maxX}x${maxY} | Ìè¨Ïù∏Ìä∏: ${trajectory.length} | ÌÅ¥Î¶≠: ${clicks.length}`;
            }

            // Ìà¥ÌåÅ Ïù¥Î≤§Ìä∏ ÏÑ§Ï†ï (trajectory Ï∂îÍ∞ÄÎ°ú ÏãúÏûëÏ†ê/ÎÅùÏ†êÎèÑ Í∞êÏßÄ)
            setupTooltip(canvas, clicks, trajectory, scaleX, scaleY, offsetX, offsetY);
        }

        let tooltipHandler = null;
        function setupTooltip(canvas, clicks, trajectory, scaleX, scaleY, offsetX, offsetY) {
            const tooltip = document.getElementById('clickTooltip');
            if (!tooltip) return;

            // Í∏∞Ï°¥ Ïù¥Î≤§Ìä∏ Ï†úÍ±∞
            if (tooltipHandler) {
                canvas.removeEventListener('mousemove', tooltipHandler);
            }

            // ÏãúÏûëÏ†ê/ÎÅùÏ†ê Ï†ïÎ≥¥
            const startPoint = trajectory.length > 0 ? trajectory[0] : null;
            const endPoint = trajectory.length > 1 ? trajectory[trajectory.length - 1] : null;

            tooltipHandler = (e) => {
                const rect = canvas.getBoundingClientRect();
                const mouseX = e.clientX - rect.left;
                const mouseY = e.clientY - rect.top;

                let found = null;
                let pointType = null;

                // ÏãúÏûëÏ†ê Í∞êÏßÄ (ÎÖπÏÉâ)
                if (startPoint) {
                    const sx = startPoint.x * scaleX + offsetX;
                    const sy = startPoint.y * scaleY + offsetY;
                    if (Math.sqrt((mouseX - sx) ** 2 + (mouseY - sy) ** 2) < 15) {
                        found = startPoint;
                        pointType = 'üü¢ ÏãúÏûëÏ†ê';
                    }
                }

                // ÎÅùÏ†ê Í∞êÏßÄ (Ï£ºÌô©ÏÉâ)
                if (!found && endPoint) {
                    const ex = endPoint.x * scaleX + offsetX;
                    const ey = endPoint.y * scaleY + offsetY;
                    if (Math.sqrt((mouseX - ex) ** 2 + (mouseY - ey) ** 2) < 15) {
                        found = endPoint;
                        pointType = 'üü† ÎÅùÏ†ê';
                    }
                }

                // ÌÅ¥Î¶≠ Ìè¨Ïù∏Ìä∏ Í∞êÏßÄ (Îπ®Í∞ÑÏÉâ)
                if (!found) {
                    for (const click of clicks) {
                        if (click.x === undefined || click.y === undefined) continue;
                        const cx = click.x * scaleX + offsetX;
                        const cy = click.y * scaleY + offsetY;
                        const dist = Math.sqrt((mouseX - cx) ** 2 + (mouseY - cy) ** 2);
                        if (dist < 15) {
                            found = click;
                            pointType = 'üî¥ ÌÅ¥Î¶≠';
                            break;
                        }
                    }
                }

                if (found) {
                    tooltip.style.display = 'block';
                    tooltip.style.left = (e.clientX - rect.left + 15) + 'px';
                    tooltip.style.top = (e.clientY - rect.top - 10) + 'px';
                    tooltip.innerHTML = `
                        <div class="stage">${pointType} | ${found.stage || 'Í∏∞ÌÉÄ'}</div>
                        <div class="coords">Ï¢åÌëú: (${found.x}, ${found.y})</div>
                        ${found.target ? `<div class="target">ÎåÄÏÉÅ: ${found.target}</div>` : ''}
                    `;
                    canvas.style.cursor = 'pointer';
                } else {
                    tooltip.style.display = 'none';
                    canvas.style.cursor = 'default';
                }
            };

            canvas.addEventListener('mousemove', tooltipHandler);
            canvas.addEventListener('mouseleave', () => {
                tooltip.style.display = 'none';
            });
        }
    </script>
</body>

</html>