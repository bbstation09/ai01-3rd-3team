<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Î°úÍ∑∏ Î∑∞Ïñ¥ | Ìã∞Ïºì ÏòàÎß§</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Malgun Gothic', 'Apple SD Gothic Neo', sans-serif;
        }

        body {
            background: #f5f5f7;
            min-height: 100vh;
        }

        .header {
            background: #fff;
            padding: 16px 40px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        .logo {
            font-size: 24px;
            font-weight: bold;
            color: #6b4fbb;
            text-decoration: none;
        }

        .logo span {
            color: #ff6b6b;
        }

        .nav-links {
            display: flex;
            gap: 16px;
        }

        .nav-links a {
            padding: 8px 16px;
            background: #f5f5f5;
            border-radius: 6px;
            color: #666;
            text-decoration: none;
            font-size: 14px;
        }

        .nav-links a:hover {
            background: #eee;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 30px;
        }

        .page-title {
            font-size: 24px;
            margin-bottom: 24px;
            color: #333;
        }

        .content-grid {
            display: grid;
            grid-template-columns: 400px 1fr;
            gap: 24px;
        }

        .card {
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            overflow: hidden;
        }

        .card-header {
            padding: 16px 20px;
            background: #f8f8f8;
            border-bottom: 1px solid #eee;
            font-weight: 600;
            font-size: 15px;
        }

        .log-list {
            max-height: 600px;
            overflow-y: auto;
        }

        .log-item {
            padding: 14px 20px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: background 0.2s;
        }

        .log-item:hover {
            background: #f8f5ff;
        }

        .log-item.active {
            background: #f0ebff;
            border-left: 4px solid #6b4fbb;
        }

        .log-item.bot {
            background: #fff5f5;
        }

        .log-item.bot.active {
            background: #ffe0e0;
            border-left-color: #dc3545;
        }

        .log-filename {
            font-size: 12px;
            color: #888;
            margin-bottom: 4px;
            font-family: monospace;
        }

        .log-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .log-badge {
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
        }

        .log-badge.human {
            background: #e3f2fd;
            color: #1976d2;
        }

        .log-badge.bot {
            background: #ffebee;
            color: #d32f2f;
        }

        .log-duration {
            font-size: 12px;
            color: #666;
        }

        /* ÏÉÅÏÑ∏ Î∑∞ */
        .detail-section {
            padding: 20px;
        }

        .detail-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 16px;
            color: #333;
        }

        .detail-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 24px;
        }

        .detail-item {
            background: #f8f8f8;
            padding: 12px;
            border-radius: 8px;
        }

        .detail-label {
            font-size: 12px;
            color: #888;
            margin-bottom: 4px;
        }

        .detail-value {
            font-size: 14px;
            font-weight: 600;
            color: #333;
        }

        /* Í∂§Ï†Å ÏãúÍ∞ÅÌôî */
        .trajectory-canvas {
            width: 100%;
            height: 300px;
            background: #1a1a2e;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        /* ÌÜµÍ≥Ñ */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
            padding: 16px;
            border-radius: 12px;
            text-align: center;
        }

        .stat-value {
            font-size: 28px;
            font-weight: 800;
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 12px;
            opacity: 0.8;
        }

        .stat-card.warning {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a5a 100%);
        }

        .stat-card.success {
            background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
        }

        /* JSON Î∑∞ */
        .json-view {
            background: #1a1a2e;
            color: #a5d6a7;
            padding: 16px;
            border-radius: 12px;
            font-family: 'Consolas', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow: auto;
            white-space: pre-wrap;
            word-break: break-all;
        }

        .empty-state {
            text-align: center;
            padding: 60px;
            color: #888;
        }

        .empty-state .icon {
            font-size: 48px;
            margin-bottom: 16px;
        }
    </style>
</head>

<body>
    <header class="header">
        <a href="/performances" class="logo">TICKET<span>PARK</span></a>
        <div class="nav-links">
            <a href="/performances">Í≥µÏó∞ Î™©Î°ù</a>
            <a href="/logout">Î°úÍ∑∏ÏïÑÏõÉ</a>
        </div>
    </header>

    <div class="container">
        <h1 class="page-title">üìä Î°úÍ∑∏ Î∑∞Ïñ¥</h1>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="totalLogs">{{ log_files|length }}</div>
                <div class="stat-label">Ï†ÑÏ≤¥ Î°úÍ∑∏</div>
            </div>
            <div class="stat-card success">
                <div class="stat-value" id="humanLogs">{{ log_files|selectattr('is_bot', 'false')|list|length }}</div>
                <div class="stat-label">Ï†ïÏÉÅ ÏÇ¨Ïö©Ïûê</div>
            </div>
            <div class="stat-card warning">
                <div class="stat-value" id="botLogs">{{ log_files|selectattr('is_bot')|list|length }}</div>
                <div class="stat-label">Î¥á ÌÉêÏßÄ</div>
            </div>
        </div>

        <div class="content-grid">
            <div class="card">
                <div class="card-header">ÏÑ∏ÏÖò Î°úÍ∑∏ Î™©Î°ù</div>
                <div class="log-list">
                    {% if log_files %}
                    {% for log in log_files %}
                    <div class="log-item {% if log.is_bot %}bot{% endif %}" onclick="loadLog('{{ log.filename }}')"
                        id="log-{{ loop.index }}">
                        <div class="log-filename">{{ log.created_at[:19] if log.created_at else '-' }} | {{
                            log.session_id }} | {{ log.display_stage }}</div>
                        <div class="log-info">
                            <span class="log-badge {% if log.is_bot %}bot{% else %}human{% endif %}">
                                {% if log.is_bot %}ü§ñ BOT{% else %}üë§ {{ log.user_email or 'Human' }}{% endif %}
                            </span>
                            <span class="log-duration">{{ (log.duration / 1000)|round(1) }}Ï¥à</span>
                        </div>
                    </div>
                    {% endfor %}
                    {% else %}
                    <div class="empty-state">
                        <div class="icon">üì≠</div>
                        <p>Î°úÍ∑∏Í∞Ä ÏóÜÏäµÎãàÎã§</p>
                    </div>
                    {% endif %}
                </div>
            </div>

            <div class="card">
                <div class="card-header">ÏÉÅÏÑ∏ Ï†ïÎ≥¥</div>
                <div id="detailContent">
                    <div class="empty-state">
                        <div class="icon">üëà</div>
                        <p>Î°úÍ∑∏Î•º ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentLog = null;

        async function loadLog(filename) {
            // ÌôúÏÑ± ÏÉÅÌÉú Î≥ÄÍ≤Ω
            document.querySelectorAll('.log-item').forEach(el => el.classList.remove('active'));
            event.currentTarget.classList.add('active');

            const response = await fetch(`/api/logs/${filename}`);
            const data = await response.json();
            currentLog = data;

            renderDetail(data);
        }

        function renderDetail(data) {
            const container = document.getElementById('detailContent');

            const isBot = data.is_bot || false;
            const botScore = data.bot_score || 0;

            // Ï≤¥Î•ò ÏãúÍ∞Ñ Í≥ÑÏÇ∞
            let durationMs = data.total_duration_ms || data.wait_duration_ms || 0;
            if (durationMs === 0) {
                if (data.page_entry_time && data.page_exit_time) {
                    durationMs = new Date(data.page_exit_time) - new Date(data.page_entry_time);
                } else if (data.queue_start_time && data.queue_end_time) {
                    durationMs = new Date(data.queue_end_time) - new Date(data.queue_start_time);
                } else if (data.booking_start_time && data.booking_end_time) {
                    durationMs = new Date(data.booking_end_time) - new Date(data.booking_start_time);
                }
            }

            // ÎßàÏö∞Ïä§ Í∂§Ï†Å ÌÜµÌï© (book Î°úÍ∑∏Îäî Ïó¨Îü¨ Îã®Í≥ÑÎ≥Ñ Í∂§Ï†ÅÏùÑ Í∞ÄÏßê)
            let allTrajectory = data.mouse_trajectory || [];
            if (data.mouse_trajectory_seats) allTrajectory = allTrajectory.concat(data.mouse_trajectory_seats);
            if (data.mouse_trajectory_discount) allTrajectory = allTrajectory.concat(data.mouse_trajectory_discount);
            if (data.mouse_trajectory_booker) allTrajectory = allTrajectory.concat(data.mouse_trajectory_booker);
            if (data.mouse_trajectory_payment) allTrajectory = allTrajectory.concat(data.mouse_trajectory_payment);
            if (data.captcha?.mouse_trajectory) allTrajectory = allTrajectory.concat(data.captcha.mouse_trajectory);
            if (data.section_selection?.mouse_trajectory) allTrajectory = allTrajectory.concat(data.section_selection.mouse_trajectory);

            // ÌÅ¥Î¶≠ Îç∞Ïù¥ÌÑ∞ ÌÜµÌï©
            let allClicks = data.clicks || [];
            if (data.seat_selection?.clicks) allClicks = allClicks.concat(data.seat_selection.clicks);
            if (data.captcha?.clicks) allClicks = allClicks.concat(data.captcha.clicks);

            // Ìò∏Î≤Ñ ÌöüÏàò Í≥ÑÏÇ∞ (actionsÏóêÏÑú hoverÍ¥ÄÎ†® Ïù¥Î≤§Ìä∏ ÏßëÍ≥Ñ)
            let hoverCount = (data.hovers || []).length;
            if (data.seat_selection?.hovers) hoverCount += data.seat_selection.hovers.length;
            if (hoverCount === 0 && data.actions) {
                hoverCount = data.actions.filter(a => a.action && a.action.includes('hover')).length;
            }

            // ÌÅ¥Î¶≠ ÌöüÏàò Í≥ÑÏÇ∞
            let clickCount = allClicks.length;
            if (clickCount === 0 && data.actions) {
                clickCount = data.actions.filter(a => a.action && (a.action.includes('click') || a.action.includes('select'))).length;
            }
            if (clickCount === 0 && data.card_clicks) {
                clickCount = data.card_clicks.length +
                    (data.date_selections || []).length +
                    (data.time_selections || []).length;
            }
            if (data.section_selection?.clicks) clickCount += data.section_selection.clicks.length;

            // Îã®Í≥Ñ ÌëúÏãú
            const stageLabels = { 'perf': 'üé≠ Í≥µÏó∞Ï∞Ω', 'que': '‚è≥ ÎåÄÍ∏∞Ïó¥', 'book': 'üé´ ÏòàÎß§Ï∞Ω' };
            const stageLabel = stageLabels[data.stage] || data.stage || '-';

            container.innerHTML = `
                <div class="detail-section">
                    <h3 class="detail-title">ÏÑ∏ÏÖò Ï†ïÎ≥¥</h3>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <div class="detail-label">ÏÑ∏ÏÖò ID</div>
                            <div class="detail-value">${data.session_id || '-'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">ÏÇ¨Ïö©Ïûê ID</div>
                            <div class="detail-value">${data.user_email || data.user_id || '-'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">IP Ï£ºÏÜå</div>
                            <div class="detail-value">${data.user_ip || '-'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Îã®Í≥Ñ</div>
                            <div class="detail-value">${stageLabel}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Ï≤¥Î•ò ÏãúÍ∞Ñ</div>
                            <div class="detail-value">${(durationMs / 1000).toFixed(1)}Ï¥à</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Î¥á Ïä§ÏΩîÏñ¥</div>
                            <div class="detail-value" style="color: ${botScore > 0.7 ? '#dc3545' : botScore > 0.4 ? '#ffc107' : '#28a745'}">
                                ${(botScore * 100).toFixed(0)}%
                            </div>
                        </div>
                    </div>
                    
                    ${isBot ? `
                        <div style="background: #fff5f5; border: 1px solid #ffcdd2; padding: 12px; border-radius: 8px; margin-bottom: 20px;">
                            <strong style="color: #d32f2f;">ü§ñ Î¥á ÌÉêÏßÄ</strong>
                            <p style="margin-top: 4px; font-size: 13px; color: #666;">
                                Ïú†Ìòï: ${data.bot_type || '-'} (${data.bot_description || '-'})
                            </p>
                        </div>
                    ` : ''}
                    
                    <h3 class="detail-title">ÎßàÏö∞Ïä§ Í∂§Ï†Å</h3>
                    <canvas class="trajectory-canvas" id="trajectoryCanvas"></canvas>
                    
                    <h3 class="detail-title">ÌñâÎèô ÌÜµÍ≥Ñ</h3>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <div class="detail-label">ÎßàÏö∞Ïä§ Í∂§Ï†Å Ìè¨Ïù∏Ìä∏</div>
                            <div class="detail-value">${allTrajectory.length}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">ÌÅ¥Î¶≠/ÏÑ†ÌÉù ÌöüÏàò</div>
                            <div class="detail-value">${clickCount}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Ìò∏Î≤Ñ ÌöüÏàò</div>
                            <div class="detail-value">${hoverCount}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">ÏÑ†ÌÉù Ï¢åÏÑù</div>
                            <div class="detail-value">${(data.selected_seats || data.seat_selection?.seats || data.seats?.selected || []).join(', ') || '-'}</div>
                        </div>
                    </div>
                    
                    <h3 class="detail-title">ÏõêÎ≥∏ Îç∞Ïù¥ÌÑ∞</h3>
                    <div class="json-view">${JSON.stringify(data, null, 2)}</div>
                </div>
            `;

            // Í∂§Ï†Å Í∑∏Î¶¨Í∏∞ - ÌÜµÌï©Îêú Í∂§Ï†ÅÍ≥º ÌÅ¥Î¶≠ ÏÇ¨Ïö©
            drawTrajectory(allTrajectory, allClicks);
        }

        function drawTrajectory(trajectory, clicks) {
            const canvas = document.getElementById('trajectoryCanvas');
            if (!canvas) return;

            const ctx = canvas.getContext('2d');
            const rect = canvas.getBoundingClientRect();
            canvas.width = rect.width;
            canvas.height = rect.height;

            if (trajectory.length === 0) {
                ctx.fillStyle = '#666';
                ctx.font = '14px sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText('Í∂§Ï†Å Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå', canvas.width / 2, canvas.height / 2);
                return;
            }

            // Ïä§ÏºÄÏùº Í≥ÑÏÇ∞
            const maxX = Math.max(...trajectory.map(p => p.x), 1);
            const maxY = Math.max(...trajectory.map(p => p.y), 1);
            const scaleX = (canvas.width - 40) / maxX;
            const scaleY = (canvas.height - 40) / maxY;
            const scale = Math.min(scaleX, scaleY);

            // Í∂§Ï†Å Í∑∏Î¶¨Í∏∞
            ctx.strokeStyle = '#667eea';
            ctx.lineWidth = 2;
            ctx.beginPath();

            trajectory.forEach((point, i) => {
                const x = point.x * scale + 20;
                const y = point.y * scale + 20;

                if (i === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            });

            ctx.stroke();

            // ÌÅ¥Î¶≠ Ìè¨Ïù∏Ìä∏
            clicks.forEach(click => {
                const x = click.x * scale + 20;
                const y = click.y * scale + 20;

                ctx.fillStyle = '#ff6b6b';
                ctx.beginPath();
                ctx.arc(x, y, 6, 0, Math.PI * 2);
                ctx.fill();
            });

            // ÏãúÏûëÏ†ê
            if (trajectory.length > 0) {
                ctx.fillStyle = '#2ecc71';
                ctx.beginPath();
                ctx.arc(trajectory[0].x * scale + 20, trajectory[0].y * scale + 20, 8, 0, Math.PI * 2);
                ctx.fill();
            }
        }
    </script>
</body>

</html>